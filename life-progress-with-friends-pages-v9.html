<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>人生進度（含朋友總覽）</title>
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0b1b2a;
      --border:#ffffff1a;
      --text:#e5e7eb;
      --muted:#a7b0bf;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:18px;
      --cardA: linear-gradient(180deg, #0b1020cc, #050816cc);
      --chip:#02061799;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang TC","Noto Sans TC",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, #1f3b5a66, transparent 60%),
        radial-gradient(900px 500px at 80% 20%, #14532d55, transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      padding:24px;
    }
    .wrap{
      width:100%;
      max-width:1180px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }
    .card{
      background: var(--cardA);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter: blur(10px);
    }
    h1{ margin:0 0 8px 0; font-size:20px; letter-spacing:.2px; }
    h2{ margin:0 0 10px 0; font-size:16px; letter-spacing:.2px; }
    .subtitle{ margin:0 0 16px 0; color:var(--muted); font-size:13px; line-height:1.6; }
    label{ display:block; color:var(--muted); font-size:13px; margin:10px 0 6px; }
    input, select, button{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#030712cc;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus{
      border-color:#7dd3fc66;
      box-shadow:0 0 0 3px #7dd3fc22;
    }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 560px){ .row{grid-template-columns:1fr} }
    button{
      background: linear-gradient(90deg, #38bdf8, #34d399);
      color:#06101d;
      font-weight:900;
      border:none;
      cursor:pointer;
      margin-top:14px;
    }
    button:hover{filter:brightness(1.05)}
    .btn2{ background: linear-gradient(90deg, #fbbf24, #fb7185); margin-top:10px; }
    .btn3{ background: linear-gradient(90deg, #a78bfa, #60a5fa); margin-top:10px; }
    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617aa;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .warn{ color:#fbbf24; }
    .danger{ color:#fca5a5; }
    .pill{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:var(--chip);
    }
    .pill .k{ color:var(--muted); font-size:12px; margin-bottom:6px; }
    .pill .v{ font-size:15px; font-weight:900; line-height:1.35; }
    .mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1;}
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px; }
    @media (max-width: 560px){ .grid2{grid-template-columns:1fr} }
    .progress{ margin-top:14px; border:1px solid var(--border); border-radius:999px; overflow:hidden; background:#020617; height:14px; }
    .bar{ height:100%; width:0%; background: linear-gradient(90deg, #a7f3d0, #7dd3fc); border-radius:999px; transition: width .6s ease; }
    .progressMeta{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; color:var(--muted); font-size:13px; }
    .affirm{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      background:
        radial-gradient(800px 220px at 20% 20%, #38bdf822, transparent 60%),
        radial-gradient(600px 200px at 80% 20%, #34d39922, transparent 60%),
        #020617cc;
      border:1px solid var(--border);
      line-height:1.75;
      white-space:pre-line;
    }
    .small{ color:var(--muted); font-size:12px; line-height:1.55; margin-top:10px; }

    /* Navigation button */
    .navBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background: radial-gradient(700px 240px at 20% 20%, #a78bfa22, transparent 60%),
                  radial-gradient(700px 240px at 80% 20%, #60a5fa22, transparent 60%),
                  #020617aa;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      width:auto;
      margin:0;
      white-space:nowrap;
    }
    .navBtn:hover{ filter:brightness(1.06); }

    .goldBtn{
      position:relative;
      overflow:hidden;
      border:none;
      color:#1a1305;
      font-weight:1000;
      letter-spacing:.5px;
      background:
        radial-gradient(900px 280px at 20% 10%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(700px 260px at 80% 10%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, #fde68a 0%, #fbbf24 22%, #f59e0b 48%, #fbbf24 72%, #fde68a 100%);
      box-shadow: 0 18px 55px rgba(0,0,0,.55), 0 0 0 1px rgba(255, 215, 95, .35) inset;
    }
    .goldBtn:before{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(120deg,
        transparent 42%,
        rgba(255,255,255,.75) 50%,
        transparent 58%);
      transform: translateX(-60%) rotate(18deg);
      animation: goldShine 2.4s linear infinite;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    .goldBtn:after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(900px 260px at 30% 0%, rgba(255,255,255,.35), transparent 55%);
      pointer-events:none;
      opacity:.65;
    }
    @keyframes goldShine{
      0%{ transform: translateX(-70%) rotate(18deg); opacity:.0; }
      10%{ opacity:.85; }
      60%{ opacity:.6; }
      100%{ transform: translateX(70%) rotate(18deg); opacity:0; }
    }

    .navWrap{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }

    /* Pages */
    .page{ display:none; }
    .page.active{ display:block; }

    /* Friends: Month board */
    .monthBoard{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .monthBoard{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 680px){ .monthBoard{grid-template-columns: repeat(2, 1fr);} }

    .monthCard{
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      min-height:140px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:#02061799;
      position:relative;
      overflow:hidden;
    }
    .monthCard::after{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(800px 260px at 30% 20%, rgba(255,255,255,.06), transparent 60%);
      pointer-events:none;
    }
    .monthTitle{ position:relative; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .monthTitle .m{ font-weight:1000; font-size:14px; letter-spacing:.2px; }
    .monthTitle .cnt{ color:var(--muted); font-size:12px; }
    .chips{ position:relative; display:flex; flex-direction:column; gap:8px; }

    /* Month deep colors */
    .monthCard[data-m="1"]{ background: linear-gradient(160deg, rgba(185,28,28,.22), rgba(2,6,23,.85)); }
    .monthCard[data-m="2"]{ background: linear-gradient(160deg, rgba(194,65,12,.22), rgba(2,6,23,.85)); }
    .monthCard[data-m="3"]{ background: linear-gradient(160deg, rgba(161,98,7,.22), rgba(2,6,23,.85)); }
    .monthCard[data-m="4"]{ background: linear-gradient(160deg, rgba(5,150,105,.18), rgba(2,6,23,.85)); }
    .monthCard[data-m="5"]{ background: linear-gradient(160deg, rgba(4,120,87,.20), rgba(2,6,23,.85)); }
    .monthCard[data-m="6"]{ background: linear-gradient(160deg, rgba(13,148,136,.18), rgba(2,6,23,.85)); }
    .monthCard[data-m="7"]{ background: linear-gradient(160deg, rgba(2,132,199,.18), rgba(2,6,23,.85)); }
    .monthCard[data-m="8"]{ background: linear-gradient(160deg, rgba(37,99,235,.18), rgba(2,6,23,.85)); }
    .monthCard[data-m="9"]{ background: linear-gradient(160deg, rgba(124,58,237,.18), rgba(2,6,23,.85)); }
    .monthCard[data-m="10"]{ background: linear-gradient(160deg, rgba(219,39,119,.16), rgba(2,6,23,.85)); }
    .monthCard[data-m="11"]{ background: linear-gradient(160deg, rgba(225,29,72,.14), rgba(2,6,23,.85)); }
    .monthCard[data-m="12"]{ background: linear-gradient(160deg, rgba(147,51,234,.18), rgba(2,6,23,.85)); }

    /* Month light chip colors */
    .chip{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      line-height:1.45;
      cursor:pointer;
      background:#0b1020cc;
    }
    .chip:hover{ filter:brightness(1.06); }
    .chip .top{ display:flex; justify-content:space-between; gap:8px; }
    .chip .nm{ font-weight:900; font-size:13px; }
    .chip .dt{ color:rgba(255,255,255,.75); font-size:12px; }
    .chip .sub{ color:rgba(255,255,255,.75); font-size:12px; margin-top:4px; }

    .chip[data-m="1"]{ background: linear-gradient(90deg, rgba(248,113,113,.26), rgba(2,6,23,.55)); }
    .chip[data-m="2"]{ background: linear-gradient(90deg, rgba(251,146,60,.26), rgba(2,6,23,.55)); }
    .chip[data-m="3"]{ background: linear-gradient(90deg, rgba(251,191,36,.24), rgba(2,6,23,.55)); }
    .chip[data-m="4"]{ background: linear-gradient(90deg, rgba(52,211,153,.22), rgba(2,6,23,.55)); }
    .chip[data-m="5"]{ background: linear-gradient(90deg, rgba(16,185,129,.22), rgba(2,6,23,.55)); }
    .chip[data-m="6"]{ background: linear-gradient(90deg, rgba(45,212,191,.22), rgba(2,6,23,.55)); }
    .chip[data-m="7"]{ background: linear-gradient(90deg, rgba(125,211,252,.22), rgba(2,6,23,.55)); }
    .chip[data-m="8"]{ background: linear-gradient(90deg, rgba(96,165,250,.22), rgba(2,6,23,.55)); }
    .chip[data-m="9"]{ background: linear-gradient(90deg, rgba(167,139,250,.22), rgba(2,6,23,.55)); }
    .chip[data-m="10"]{ background: linear-gradient(90deg, rgba(244,114,182,.20), rgba(2,6,23,.55)); }
    .chip[data-m="11"]{ background: linear-gradient(90deg, rgba(251,113,133,.18), rgba(2,6,23,.55)); }
    .chip[data-m="12"]{ background: linear-gradient(90deg, rgba(192,132,252,.22), rgba(2,6,23,.55)); }

    /* Filter pills */
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      align-items:center;
    }
    .filterBtn{
      width:auto;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617aa;
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      margin:0;
      white-space:nowrap;
    }
    .filterBtn.active{
      background: linear-gradient(90deg, #38bdf8, #34d399);
      color:#06101d;
      border:none;
    }

    /* Leaderboard */
    .lb{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .lbRow{
      border:1px solid var(--border);
      border-radius:16px;
      background:#02061799;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
.lbRow{
  position:relative;
  overflow:hidden;
}
.lbRow::before{
  content:"";
  position:absolute;
  inset:0;
  width: calc(min(var(--pct, 0), 100) * 1%);
  background: linear-gradient(90deg, rgba(56,189,248,.38), rgba(125,211,252,.18));
  pointer-events:none;
}
.lbRow.over::before{
  width: 100%;
  background: linear-gradient(90deg, rgba(251,191,36,.55), rgba(251,191,36,.20));
}
.lbRow > *{ position:relative; z-index:1; }
.lbRight .big{
  display:inline-block;
  padding:8px 10px;
  border-radius:12px;
  background: rgba(56,189,248,.18);
  border:1px solid rgba(56,189,248,.25);
}
.lbRow.over .lbRight .big{
  background: rgba(251,191,36,.22);
  border:1px solid rgba(251,191,36,.35);
}

    .lbRow:hover{ filter:brightness(1.05); }
    .rank{
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0b1020cc;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      flex:0 0 auto;
    }
    .lbMain{ flex:1 1 auto; }
    .lbMain .nm{ font-weight:1000; }
    .lbMain .meta{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.55; }
    .lbRight{ text-align:right; color:var(--text); }
    .lbRight .age{ font-weight:1000; }
    .lbRight .days{ margin-top:4px; color:var(--muted); font-size:12px; }

    /* Friend detail modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:100%;
      max-width:720px;
      border-radius:22px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #0b1020f2, #050816f2);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .modalHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .closeBtn{
      width:auto;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#020617aa;
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      margin:0;
    }
    .closeBtn:hover{ filter:brightness(1.06); }
    .dangerBtn{
      background: linear-gradient(90deg, #fbbf24, #fb7185);
      color:#06101d;
      border:none;
    }
    .modalActions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  
    .seg{display:flex;gap:6px;align-items:center;}
    .segBtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617aa;
      color:var(--muted);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .segBtn:hover{filter:brightness(1.05)}
    .segBtn.active{
      background: linear-gradient(90deg, #38bdf8, #34d399);
      color:#06101d;
      border:none;
    }
    .monthBoard.rowLayout{
      display:grid;
      grid-template-columns: repeat(12, minmax(240px, 1fr));
      gap:12px;
      overflow-x:auto;
      padding-bottom:8px;
      scroll-snap-type:x mandatory;
    }
    .monthBoard.rowLayout .monthCard{ scroll-snap-align:start; }
    .nameOnly{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .nameOnly .chipBtn{
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
    }
    .countPill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:22px;
      height:22px;
      padding:0 8px;
      border-radius:999px;
      background:#020617cc;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      margin-left:8px;
    }

  
    .segBtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617aa;
      color:var(--muted);
      font-weight:900;
      cursor:pointer;
      width:auto;
    }
    .segBtn.active{
      background: linear-gradient(90deg, #38bdf8, #34d399);
      color:#06101d;
      border:none;
    }

</style>
</head>

<body>
  <!-- PAGE: MAIN -->
  <div class="page active" id="pageMain">
    <div class="wrap">
      <!-- LEFT COLUMN -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
          <div>
            <h1>人生進度（依地點平均壽命）</h1>
            <p class="subtitle">
              以你的「所在地國家 + 性別」抓取<strong>最新可用的平均壽命（出生時預期壽命）</strong>，當作人生進度的分母。
              你也可以按右邊的彩色按鈕，進入「朋友總覽」。
            </p>
          </div>
          <span class="badge" id="status">等待輸入</span>
        </div>

        <div class="row">
          <div>
            <label for="birthDate">你的出生年月日</label>
            <input type="date" id="birthDate" />
          </div>
          <div>
            <label for="birthTime">出生時間（選填）</label>
            <input type="time" id="birthTime" step="60" placeholder="HH:MM" />
          </div>
        </div>

<div class="row" style="margin-top:10px;">
  <div>
    <label for="langSelect">介面語言</label>
    <select id="langSelect">
      <option value="zh-Hant" selected>繁體中文</option>
      <option value="en">English</option>
    </select>
  </div>
  <div>
    <label for="basisCountry">壽命基準國家</label>
    <select id="basisCountry">
      <option value="auto" selected>自動（用目前地點）</option>
      <option value="__manual__">手動輸入壽命</option>
      <option value="TW">台灣 TW</option>
      <option value="HK">香港 HK</option>
      <option value="JP">日本 JP</option>
      <option value="CN">中國 CN</option>
      <option value="US">美國 US</option>
      <option value="GB">英國 GB</option>
      <option value="SG">新加坡 SG</option>
      <option value="KR">韓國 KR</option>
      <option value="AU">澳洲 AU</option>
      <option value="CA">加拿大 CA</option>
    </select>
  </div>
</div>

        <div class="row">
          <div>
            <label for="sex">性別（用於平均壽命）</label>
            <select id="sex">
              <option value="total" selected>不指定（總平均）</option>
              <option value="male">男</option>
              <option value="female">女</option>
            </select>
          </div>
          <div>
            <label for="mode">更新模式</label>
            <select id="mode">
              <option value="live" selected>即時更新（每秒）</option>
              <option value="static">靜態（按一次就好）</option>
            </select>
          </div>
        </div>

        <div class="navWrap">
          <button id="calcBtn">開始計算（用目前地點）</button>
          <button class="btn2" id="calcManualBtn">不取地點（手動輸入壽命）</button>
        </div>

        <div class="grid2" id="stats" style="display:none;">
          <div class="pill"><div class="k">你已經活了</div><div class="v mono" id="alive1">—</div></div>
          <div class="pill"><div class="k">總秒數</div><div class="v mono" id="aliveSec">—</div></div>
          <div class="pill"><div class="k">人生進度</div><div class="v mono" id="progressPct">—</div></div>
          <div class="pill"><div class="k">大約還有</div><div class="v mono" id="remain">—</div></div>
        </div>

        <div id="progressBlock" style="display:none;">
          <div class="progress"><div class="bar" id="bar"></div></div>
          <div class="progressMeta">
            <div class="mono" id="progressMetaLeft">—</div>
            <div class="mono" id="progressMetaRight">—</div>
          </div>
          <div class="affirm" id="affirm">—</div>
          <div class="small" id="note"></div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
            <div>
              <h2 style="margin:0;">命理卡片區（你自己）</h2>
              <div class="small" style="margin-top:6px;">
                星座／生肖／天干地支／五行／出生星期／年度第幾天
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end;">
              <span class="badge" id="mingliBadge">等待輸入</span>
              <button class="navBtn goldBtn" id="goFriendsBtn" title="進入朋友總覽">朋友總覽</button>
            </div>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="pill"><div class="k">西方星座</div><div class="v" id="westernZodiac">—</div></div>
            <div class="pill"><div class="k">星期幾出生</div><div class="v" id="weekday">—</div></div>
            <div class="pill"><div class="k">中國生肖</div><div class="v" id="chineseZodiac">—</div></div>
            <div class="pill"><div class="k">天干地支</div><div class="v" id="ganzhi">—</div></div>
            <div class="pill"><div class="k">五行屬性</div><div class="v" id="wuxing">—</div></div>
            <div class="pill"><div class="k">年度第幾天</div><div class="v" id="doy">—</div></div>
          </div>

          <div class="small">
            提示：生肖／天干地支嚴謹算法需考慮立春/農曆新年切換；本頁以公曆年份近似。
          </div>
        </div>

        
        <div class="card" style="margin-top:18px;" id="groupPosCard">
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
            <div>
              <h2 style="margin:0;">我在我們這群人之中</h2>
              <div class="small" style="margin-top:6px;">不是輸贏，是位置感：用「人生進度％（同一壽命基準）」在你朋友群體裡定位。</div>
            </div>
            <span class="badge" id="gpBadge">等待計算</span>
          </div>

          <div class="grid" style="margin-top:14px;">
            <div class="pill">
              <div class="k">你在這群人中</div>
              <div class="v mono" id="gpRank">—</div>
            </div>
            <div class="pill">
              <div class="k">你比多少人更前面</div>
              <div class="v mono" id="gpAhead">—</div>
            </div>
            <div class="pill" style="grid-column:1 / -1;">
              <div class="k">最接近你的人生進度</div>
              <div class="v mono" id="gpClosest">—</div>
            </div>
          </div>

          <div class="small" id="gpNote" style="margin-top:10px;">
            以主頁目前的「平均壽命分母」作為共同基準，方便比較；若未加入朋友，會只顯示你自己。
          </div>
        </div>

<div class="card" style="margin-top:18px;">
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
            <h2 style="margin:0;">來源與地點</h2>
            <span class="badge" id="locBadge">未取得地點</span>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="pill"><div class="k">偵測到的國家</div><div class="v" id="country">—</div></div>
            <div class="pill"><div class="k">平均壽命（最新）</div><div class="v mono" id="lifeExpect">—</div></div>
            <div class="pill"><div class="k">資料年份</div><div class="v mono" id="lifeYear">—</div></div>
            <div class="pill"><div class="k">備註</div><div class="v" style="font-size:13px;font-weight:800;" id="metaNote">—</div></div>
          </div>

          <div class="small">
            平均壽命使用 World Bank 指標：總平均 <span class="mono">SP.DYN.LE00.IN</span>、男 <span class="mono">SP.DYN.LE00.MA.IN</span>、女 <span class="mono">SP.DYN.LE00.FE.IN</span>。
            地點透過瀏覽器定位（通常需 HTTPS）→ Nominatim 反向地理編碼取得國家碼。
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGE: FRIENDS -->
  <div class="page" id="pageFriends" style="max-width:1180px;margin:0 auto;">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
        <h1 style="margin:0;">朋友總覽</h1>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <span class="badge" id="friendsBadge">0 位朋友</span>
          <button class="navBtn" id="backBtn" title="返回人生進度">返回</button>
        </div>
      </div>
      <div class="pill" id="nextBdayFriends" style="margin-top:12px;"><div class="k">下一個生日</div><div class="v" id="nextBdayFriendsText">—</div></div>
      <p class="subtitle" style="margin-top:10px;">
        新增：<strong>匯出 Excel（CSV）</strong>、<strong>12 星座篩選</strong>、<strong>分類別/全體年齡排行榜</strong>。
      </p>

      <div class="row">
        <div>
          <label for="friendName">朋友名字</label>
          <input id="friendName" placeholder="例如：Aiden / Chris / 小明" />
        </div>
        <div>
          <label for="friendDob">出生年月日</label>
          <input type="date" id="friendDob" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="friendSex">性別（可選，用於顯示）</label>
          <select id="friendSex">
            <option value="unspecified" selected>不指定</option>
            <option value="male">男</option>
            <option value="female">女</option>
          </select>
        </div>
        <div>
          <label for="friendTag">備註（分類）</label>
          <select id="friendTag">
            <option value="" selected>不指定</option>
            <option value="同事">同事</option>
            <option value="同學">同學</option>
            <option value="家人">家人</option>
            <option value="朋友">朋友</option>
            <option value="學生">學生</option>
            <option value="老師">老師</option>
            <option value="伴侶">伴侶</option>
            <option value="其他">其他</option>
          </select>
        </div>
      </div>
      <button class="btn3" id="addFriendBtn">加入朋友</button>

      <div class="filters">
        <button class="filterBtn" id="exportExcelBtn">製作 Excel（多分頁）</button>
        <button class="filterBtn dangerBtn" id="clearBtn" style="border:none;">清空朋友名單</button>
      </div>

      <div class="small">
        這裡的「Excel」會輸出含多個工作表的 Excel 檔，Excel / Numbers / Google Sheets 都可直接開啟與排序。
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
        <h2 style="margin:0;">12 星座篩選</h2>
        <span class="badge" id="zodiacBadge">顯示：全部</span>
      </div>
      <div class="filters" id="zodiacFilters"></div>
      <div class="small">點一下切換顯示；再次點「全部」可清除篩選。</div>
    </div>

    
    <div class="card" style="margin-top:18px;">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
        <h2 style="margin:0;">關係篩選</h2>
        <span class="badge" id="tagBadge">顯示：全部</span>
      </div>
      <div class="filters" id="tagFilters"></div>
      <div class="small">點一下切換顯示；再次點「全部」可清除篩選。</div>
    </div>
<div class="card" style="margin-top:18px;">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
        <h2 style="margin:0;">12 個月份一頁看齊</h2>
        
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;">
          <div class="seg">
            <button class="segBtn" id="layoutGridBtn" type="button">3×4</button>
            <button class="segBtn" id="layoutRowBtn" type="button">1×12</button>
          </div>
          <div class="seg">
            <button class="segBtn" id="sortMonthBtn" type="button">月份順序</button>
            <button class="segBtn" id="sortCountBtn" type="button">人數排序</button>
          </div>
          <span class="badge" id="monthBadge">—</span>
        </div>
      </div>
      <div class="monthBoard" id="monthBoard"></div>
      <div class="small">月份是深色底；該月生日的人會用同月淺色 chip 顯示。點 chip 可看詳情。</div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
        <h2 style="margin:0;" id="rankTitle">年齡排行榜</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;">
          <div class="seg" style="display:flex;gap:8px;align-items:center;"><button class="segBtn active" id="rankModeAge" type="button">年齡</button><button class="segBtn" id="rankModeProgress" type="button">人生進度%</button></div><select id="rankBasisCountry" style="width:auto;min-width:160px;"><option value="__main__" selected>壽命基準：跟主頁</option><option value="auto">自動（用目前地點）</option><option value="TW">台灣</option><option value="HK">香港</option><option value="JP">日本</option><option value="CN">中國</option><option value="US">美國</option><option value="GB">英國</option><option value="SG">新加坡</option><option value="KR">韓國</option><option value="AU">澳洲</option><option value="CA">加拿大</option><option value="SE">瑞典</option><option value="DE">德國</option><option value="FR">法國</option></select><select id="rankTagFilter" style="width:auto;min-width:160px;">
            <option value="__all__" selected>全部分類</option>
          </select>
          <span class="badge" id="rankBadge">—</span>
        </div>
      </div>
      <div class="lb" id="leaderboard"></div>
      <div class="small">排序：由年長 → 年幼（依生日先後）。點任何一列可看詳情。</div>
    </div>
  </div>

  <!-- Friend detail modal -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-label="friend detail">
      <div class="modalHeader">
        <div>
          <h2 style="margin:0;" id="detailTitle">朋友詳情</h2>
          <div class="small" id="detailSub" style="margin-top:6px;">—</div>
        </div>
        <button class="closeBtn" id="closeOverlayBtn">關閉</button>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="pill"><div class="k">生日</div><div class="v mono" id="detailDob">—</div></div>
        <div class="pill"><div class="k">年齡（約）</div><div class="v mono" id="detailAge">—</div></div>
        <div class="pill"><div class="k">西方星座</div><div class="v" id="detailWest">—</div></div>
        <div class="pill"><div class="k">中國生肖</div><div class="v" id="detailCz">—</div></div>
        <div class="pill"><div class="k">天干地支</div><div class="v" id="detailGz">—</div></div>
        <div class="pill"><div class="k">五行</div><div class="v" id="detailWx">—</div></div>
      </div>

      <div class="modalActions">
        <button class="closeBtn" id="jumpMonthBtn" style="width:auto;">跳到月份</button>
        <button class="closeBtn dangerBtn" id="deleteFriendBtn" style="width:auto;">刪除</button>
      </div>

      <div class="small">註：命理資料以公曆年份近似（未處理立春/農曆新年切換）。</div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script>

  let timer = null;

  const STEMS = ["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"];
  const BRANCHES = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];
  const STEM_ELEMENT = {"甲":"木","乙":"木","丙":"火","丁":"火","戊":"土","己":"土","庚":"金","辛":"金","壬":"水","癸":"水"};
  const CHINESE_ZODIAC = ["鼠","牛","虎","兔","龍","蛇","馬","羊","猴","雞","狗","豬"];
  const STORAGE_KEY = "life_progress_friends_v4";

  const ZODIAC = [
    { id:"capricorn", name:"摩羯", range:"12/22–1/19" },
    { id:"aquarius", name:"水瓶", range:"1/20–2/18" },
    { id:"pisces", name:"雙魚", range:"2/19–3/20" },
    { id:"aries", name:"牡羊", range:"3/21–4/19" },
    { id:"taurus", name:"金牛", range:"4/20–5/20" },
    { id:"gemini", name:"雙子", range:"5/21–6/20" },
    { id:"cancer", name:"巨蟹", range:"6/21–7/22" },
    { id:"leo", name:"獅子", range:"7/23–8/22" },
    { id:"virgo", name:"處女", range:"8/23–9/22" },
    { id:"libra", name:"天秤", range:"9/23–10/22" },
    { id:"scorpio", name:"天蠍", range:"10/23–11/21" },
    { id:"sagittarius", name:"射手", range:"11/22–12/21" }
  ];

  const TAGS = ["同事","同學","家人","朋友","學生","老師","伴侶","客戶","其他"];


  let zodiacFilter = "__all__";
  let tagFilter = "__all__";
  let monthLayout = "grid";
  let monthSort = "month";

  function setStatus(text, cls=""){
    const el = document.getElementById("status");
    el.textContent = text;
    el.className = "badge " + cls;
  }

  function showPage(which){
    const main = document.getElementById("pageMain");
    const friends = document.getElementById("pageFriends");
    main.classList.remove("active");
    friends.classList.remove("active");
    if(which === "friends"){
      friends.classList.add("active");
      location.hash = "#friends";
      renderFriends();
      window.scrollTo({top:0, behavior:"auto"});
    }else{
      main.classList.add("active");
      location.hash = "#";
      window.scrollTo({top:0, behavior:"auto"});
    }
  }

  function parseBirthDateTime(){
    const d = document.getElementById("birthDate").value;
    if(!d) return null;
    const t = document.getElementById("birthTime").value;
    const [yyyy, MM, dd] = d.split("-").map(x=>parseInt(x,10));
    if(t){
      const [hh, mm] = t.split(":").map(x=>parseInt(x,10));
      return new Date(yyyy, MM-1, dd, hh||0, mm||0, 0, 0);
    }
    return new Date(yyyy, MM-1, dd, 12, 0, 0, 0);
  }

  function formatAlive(diffMs){
    const totalSeconds = Math.floor(diffMs / 1000);
    const totalMinutes = Math.floor(totalSeconds / 60);
    const totalHours = Math.floor(totalMinutes / 60);
    const totalDays = Math.floor(totalHours / 24);
    const years = Math.floor(totalDays / 365.2425);
    return { years, totalDays, totalHours, totalMinutes, totalSeconds };
  }

  function getChineseZodiacByYear(year){
    const idx = ((year - 2020) % 12 + 12) % 12;
    return CHINESE_ZODIAC[idx];
  }

  function getGanzhiByYear(year){
    const offset = year - 1984;
    const stem = STEMS[((offset % 10) + 10) % 10];
    const branch = BRANCHES[((offset % 12) + 12) % 12];
    return { gz: stem + branch, stem };
  }

  function getWesternZodiacId(date){
    const m = date.getMonth()+1;
    const d = date.getDate();
    if((m===12 && d>=22) || (m===1 && d<=19)) return "capricorn";
    if((m===1 && d>=20) || (m===2 && d<=18)) return "aquarius";
    if((m===2 && d>=19) || (m===3 && d<=20)) return "pisces";
    if((m===3 && d>=21) || (m===4 && d<=19)) return "aries";
    if((m===4 && d>=20) || (m===5 && d<=20)) return "taurus";
    if((m===5 && d>=21) || (m===6 && d<=20)) return "gemini";
    if((m===6 && d>=21) || (m===7 && d<=22)) return "cancer";
    if((m===7 && d>=23) || (m===8 && d<=22)) return "leo";
    if((m===8 && d>=23) || (m===9 && d<=22)) return "virgo";
    if((m===9 && d>=23) || (m===10 && d<=22)) return "libra";
    if((m===10 && d>=23) || (m===11 && d<=21)) return "scorpio";
    return "sagittarius";
  }

  function getWesternZodiacLabel(date){
    const id = getWesternZodiacId(date);
    const z = ZODIAC.find(x=>x.id===id);
    return z ? `${z.name}（${z.range}）` : "—";
  }

  function dayOfYear(date){
    const start = new Date(date.getFullYear(), 0, 1);
    return Math.floor((date - start) / 86400000) + 1;
  }

  function affirmMessage({pct, lifeExpYears, country, sex}){
    const base = [
      "你不需要把每一天都過得驚天動地。能穩定地走在自己的節奏上，本身就是一種力量。",
      "今天只要做一件『對你有益』的小事，就足夠了。",
      "人生不是衝刺，是長跑。你已經在路上，這件事本身就值得肯定。",
      "把目標放小，把行動放近。你能做的，比你想像的更多。"
    ];
    const hint =
      (pct < 25) ? "你還有大量空間去試錯、去選擇、去成為你想成為的人。"
      : (pct < 50) ? "你正在進入更能掌握自己的階段：把時間花在真正重要的人事物上。"
      : (pct < 75) ? "你已經累積了很多，接下來更適合做『減法』：留下會讓你發光的。"
      : "你走過很多路。接下來的日子，請把幸福與健康放到更前面。";

    const sexText = (sex==="male") ? "男性" : (sex==="female" ? "女性" : "總平均");
    const ctx = (country && lifeExpYears && country !== "—")
      ? `

（以 ${country.toUpperCase()}／${sexText} 的平均壽命 ${lifeExpYears.toFixed(1)} 年估算）`
      : "";

    const pick = base[Math.floor(Math.random()*base.length)];
    return (pick + "\\n\\n" + hint + ctx).trim();
  }

  async function getLocationCountryCode(){
    if(!navigator.geolocation) throw new Error("此瀏覽器不支援定位");
    const pos = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 12000,
        maximumAge: 60000
      });
    });
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    document.getElementById("locBadge").textContent = "已取得座標";
    document.getElementById("locBadge").className = "badge";

    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if(!res.ok) throw new Error("反向地理編碼失敗");
    const data = await res.json();
    const cc = data?.address?.country_code;
    if(!cc) throw new Error("無法取得國家碼");
    return cc.toLowerCase();
  }

  function indicatorForSex(sex){
    if(sex === "male") return "SP.DYN.LE00.MA.IN";
    if(sex === "female") return "SP.DYN.LE00.FE.IN";
    return "SP.DYN.LE00.IN";
  }

  async function fetchLifeExpectancy(countryCode, sex){
    const indicator = indicatorForSex(sex);
    const url = `https://api.worldbank.org/v2/country/${countryCode}/indicator/${indicator}?format=json&per_page=60`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("World Bank API 讀取失敗（可能被 CORS 或網路阻擋）");
    const json = await res.json();
    const arr = json?.[1];
    if(!Array.isArray(arr)) throw new Error("World Bank API 回傳格式不符");
    const latest = arr.find(x => x && x.value !== null && x.value !== undefined);
    if(!latest) throw new Error("找不到可用的平均壽命數值");
    return { value: Number(latest.value), year: latest.date, indicator };
  }

  function computeAndRender(birth, lifeExpYears, countryCode, sex, indicator, dataYear){
    const now = new Date();
    const diffMs = now - birth;
    if(diffMs < 0){
      setStatus("出生日期在未來", "danger");
      return;
    }

    const totalLifeMs = lifeExpYears * 365.2425 * 24 * 3600 * 1000;
    const pct = Math.min(100, Math.max(0, (diffMs / totalLifeMs) * 100));
    const alive = formatAlive(diffMs);

    document.getElementById("stats").style.display = "grid";
    document.getElementById("progressBlock").style.display = "block";

    document.getElementById("alive1").textContent =
      `${alive.years} 年｜${alive.totalDays.toLocaleString("zh-Hant-TW")} 天｜${alive.totalHours.toLocaleString("zh-Hant-TW")} 小時`;
    document.getElementById("aliveSec").textContent = `${alive.totalSeconds.toLocaleString("zh-Hant-TW")} 秒`;
    document.getElementById("progressPct").textContent = `${pct.toFixed(2)}%`;

    const remainMs = Math.max(0, totalLifeMs - diffMs);
    const remainDays = Math.floor(remainMs / 86400000);
    const remainYears = (remainMs / (365.2425*86400000)).toFixed(1);
    document.getElementById("remain").textContent = `${remainYears} 年（約 ${remainDays.toLocaleString("zh-Hant-TW")} 天）`;

    document.getElementById("bar").style.width = `${pct}%`;
    document.getElementById("progressMetaLeft").textContent = `已完成：${pct.toFixed(2)}%`;
    document.getElementById("progressMetaRight").textContent =
      `分母：平均壽命 ${lifeExpYears.toFixed(1)} 年（${countryCode.toUpperCase()}｜${indicator}｜${dataYear}）`;

    document.getElementById("affirm").textContent = affirmMessage({pct, lifeExpYears, country: countryCode, sex});
    document.getElementById("note").textContent =
      "提示：平均壽命為統計值（出生時預期壽命），不等同於個人實際壽命；更嚴謹可改用年齡別生命表（conditional life expectancy）。";

    document.getElementById("country").textContent = countryCode.toUpperCase();
    document.getElementById("lifeExpect").textContent = `${lifeExpYears.toFixed(2)} 年`;
    document.getElementById("lifeYear").textContent = `${dataYear}`;
    const sexText = (sex==="male") ? "男性" : (sex==="female" ? "女性" : "總平均");
    document.getElementById("metaNote").textContent = `來源：World Bank 指標 ${indicator}（${sexText}）｜使用最新可用年份。`;

    // 命理卡片區（你自己）
    const western = getWesternZodiacLabel(birth);
    const weekdayNames = ["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];
    const weekday = weekdayNames[birth.getDay()];
    const doy = dayOfYear(birth);
    const y = birth.getFullYear();
    const zodiac = getChineseZodiacByYear(y);
    const gzObj = getGanzhiByYear(y);
    const gz = gzObj.gz;
    const wx = STEM_ELEMENT[gzObj.stem] || "—";

    document.getElementById("westernZodiac").textContent = western;
    document.getElementById("weekday").textContent = weekday;
    document.getElementById("doy").textContent = `第 ${doy} 天`;
    document.getElementById("chineseZodiac").textContent = `${zodiac}（${y} 年）`;
    document.getElementById("ganzhi").textContent = `${gz} 年`;
    document.getElementById("wuxing").textContent = `${wx}（天干「${gzObj.stem}」）`;
    document.getElementById("mingliBadge").textContent = "已更新";

    // 保存主頁基準（供「群體定位」與排行榜共用）
    window.__SELF_CTX = {
      birthMs: birth.getTime(),
      lifeExpYears: lifeExpYears,
      countryCode: countryCode,
      sex: sex,
      indicator: indicator,
      dataYear: dataYear,
      rawPct: (diffMs / totalLifeMs) * 100
    };
    updateGroupPosition();

    setStatus("已更新", "");
  }

  async function runWithLocation(){
    const birth = parseBirthDateTime();
    if(!birth){ alert("請先輸入你的出生年月日"); return; }
    if(timer){ clearInterval(timer); timer = null; }

    setStatus("取得地點中…", "warn");
    document.getElementById("locBadge").textContent = "請允許定位";
    document.getElementById("locBadge").className = "badge warn";

    const sex = document.getElementById("sex").value;

const basisPick = (document.getElementById("basisCountry")?.value) || "auto";
// If user chooses manual basis, route to manual flow
if(basisPick === "__manual__"){
  return runManual();
}

// If user chooses a specific country, do NOT prompt geolocation
if(basisPick !== "auto"){
  const cc = String(basisPick).toLowerCase();
  document.getElementById("locBadge").textContent = `基準國家：${cc.toUpperCase()}`;
  document.getElementById("locBadge").className = "badge";

  setStatus("讀取平均壽命中…", "warn");
  let value = 80, year="—", indicator="manual";
  try{
    const api = await fetchLifeExpectancy(cc, sex);
    value = api.value; year = api.year; indicator = api.indicator;
  }catch(e){
    const fb = LIFE_FALLBACK[String(cc).toUpperCase()];
    if(fb){
      value = (sex==="male") ? fb.male : (sex==="female" ? fb.female : fb.total);
      year = "fallback";
      indicator = "fallback";
    }
  }

  const mode = document.getElementById("mode").value;
  computeAndRender(birth, value, cc, sex, indicator, year);

  // save for friends ranking basis
  localStorage.setItem("life_last_value", String(value));
  localStorage.setItem("life_last_country", String(cc).toUpperCase());

  if(mode === "live"){
    timer = setInterval(() => computeAndRender(birth, value, cc, sex, indicator, year), 1000);
  }
  return;
}

    try{
      const cc = await getLocationCountryCode();
      document.getElementById("locBadge").textContent = `國家碼：${cc.toUpperCase()}`;
      document.getElementById("locBadge").className = "badge";

      setStatus("讀取平均壽命中…", "warn");
      const { value, year, indicator } = await fetchLifeExpectancy(cc, sex);

      const mode = document.getElementById("mode").value;
      computeAndRender(birth, value, cc, sex, indicator, year);

      if(mode === "live"){
        timer = setInterval(() => computeAndRender(birth, value, cc, sex, indicator, year), 1000);
      }
    }catch(err){
      console.error(err);
      setStatus("取得失敗", "danger");
      document.getElementById("locBadge").textContent = "未取得地點";
      document.getElementById("locBadge").className = "badge danger";
      document.getElementById("metaNote").textContent =
        "可能原因：未允許定位、非 HTTPS、或外部 API 被瀏覽器/CORS 阻擋。你可改用『手動輸入壽命』模式。";
      alert("自動取得地點/平均壽命失敗。\\n建議：\\n1) 部署到 HTTPS（例如 GitHub Pages）\\n2) 或使用『手動輸入壽命』模式。");
    }
  }

  function runManual(){
    const birth = parseBirthDateTime();
    if(!birth){ alert("請先輸入你的出生年月日"); return; }
    const v = prompt("請輸入你想用的『假設壽命（年）』，例如 80 或 84.6：", "80");
    if(!v) return;
    const life = Number(v);
    if(!isFinite(life) || life <= 0 || life > 130){
      alert("壽命數值不合理，請輸入 1～130 之間的數值。");
      return;
    }

    if(timer){ clearInterval(timer); timer = null; }
    const sex = document.getElementById("sex").value;
    const mode = document.getElementById("mode").value;

    computeAndRender(birth, life, "—", sex, "manual", "—");
    setStatus("已更新（手動）", "");

    if(mode === "live"){
      timer = setInterval(() => computeAndRender(birth, life, "—", sex, "manual", "—"), 1000);
    }
  }

  // ============================
  // Friends: storage + helpers
  // ============================
  function loadFriends(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const data = JSON.parse(raw);
      if(!Array.isArray(data)) return [];
      return data.filter(x => x && x.id && x.name && x.dob);
    }catch(e){
      return [];
    }
  }

  function saveFriends(list){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  function uuid(){
    return "f_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function parseDateOnly(yyyy_mm_dd){
    const [y,m,d] = yyyy_mm_dd.split("-").map(n=>parseInt(n,10));
    return new Date(y, m-1, d, 12, 0, 0, 0);
  }

  function ageApprox(date){
    const now = new Date();
    const diffMs = now - date;
    const days = Math.floor(diffMs / 86400000);
    const years = (diffMs / (365.2425*86400000));
    return { days, years, ms: diffMs };
  }

  function fmtDob(dob){
    const [y,m,d] = dob.split("-");
    return `${m}/${d}`;
  }

  function sexLabel(s){
    if(s==="male") return "男";
    if(s==="female") return "女";
    return "不指定";
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    })[c]);
  }

  function applyZodiacFilter(list){
    if(zodiacFilter === "__all__") return list;
    return list.filter(f => {
      const dt = parseDateOnly(f.dob);
      return getWesternZodiacId(dt) === zodiacFilter;
    });
  }

  function applyTagFilter(list){
    if(tagFilter === "__all__") return list;
    return list.filter(f => (f.tag||"") === tagFilter);
  }

  function uniqueTags(list){
    const set = new Set();
    for(const f of list){
      if(f.tag) set.add(f.tag);
    }
    return Array.from(set).sort((a,b)=> a.localeCompare(b, "zh-Hant-TW"));
  }

  // detail modal state
  let currentDetailId = null;

  function openDetail(friendId){
    const list = loadFriends();
    const f = list.find(x=>x.id===friendId);
    if(!f) return;

    currentDetailId = friendId;

    const dt = parseDateOnly(f.dob);
    const a = ageApprox(dt);
    const west = getWesternZodiacLabel(dt);
    const cz = getChineseZodiacByYear(dt.getFullYear());
    const gzObj = getGanzhiByYear(dt.getFullYear());
    const wx = STEM_ELEMENT[gzObj.stem] || "—";

    document.getElementById("detailTitle").textContent = f.name;
    document.getElementById("detailSub").textContent = `${sexLabel(f.sex || "unspecified")}${f.tag ? `｜${f.tag}` : ""}`;
    document.getElementById("detailDob").textContent = f.dob;
    document.getElementById("detailAge").textContent = `${a.years.toFixed(2)} 歲（${a.days.toLocaleString("zh-Hant-TW")} 天）`;
    document.getElementById("detailWest").textContent = west;
    document.getElementById("detailCz").textContent = `${cz}（${dt.getFullYear()} 年）`;
    document.getElementById("detailGz").textContent = `${gzObj.gz} 年`;
    document.getElementById("detailWx").textContent = `${wx}（天干「${gzObj.stem}」）`;

    document.getElementById("overlay").classList.add("show");
  }

  function closeDetail(){
    document.getElementById("overlay").classList.remove("show");
    currentDetailId = null;
  }

  function deleteCurrent(){
    if(!currentDetailId) return;
    const list = loadFriends();
    const f = list.find(x=>x.id===currentDetailId);
    const ok = confirm(`確定要刪除「${f ? f.name : "這位朋友"}」？`);
    if(!ok) return;
    saveFriends(list.filter(x=>x.id!==currentDetailId));
    closeDetail();
    renderFriends();
  }

  function jumpCurrentMonth(){
    if(!currentDetailId) return;
    const list = loadFriends();
    const f = list.find(x=>x.id===currentDetailId);
    if(!f) return;
    const dt = parseDateOnly(f.dob);
    const m = dt.getMonth()+1;
    const el = document.getElementById(`month_${m}`);
    if(el) el.scrollIntoView({ behavior:"smooth", block:"start" });
    closeDetail();
  }

  // ============================
  // CSV export (Excel-friendly)
  // ============================
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function toCSVRow(arr){
    return arr.map(v => {
      const s = String(v ?? "");
      if(/[",\\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }).join(",");
  }

  
  
  function exportExcelWorkbook(){
    const raw = loadFriends();
    if(raw.length === 0){
      alert("目前沒有朋友資料可匯出。");
      return;
    }

    // Require SheetJS
    if(typeof XLSX === "undefined" || !XLSX.utils){
      alert("Excel 匯出需要載入 SheetJS（xlsx）函式庫。\n請確保目前有網路，或把此頁部署到可連網的環境再試一次。");
      return;
    }

    const now = new Date();
    const ts = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}`;

    // ---- helpers ----
    const mdKey = (d)=>`${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
    const mdText = (d)=>`${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
    const safeSheetName = (s)=>{
      let name = String(s||"Sheet").replace(/[\\\/\?\*\[\]\:]/g, " ");
      name = name.trim() || "Sheet";
      if(name.length > 31) name = name.slice(0,31);
      return name;
    };

    const rows = raw.map(f=>{
      const dt = parseDateOnly(f.dob);
      const westId = getWesternZodiacId(dt);
      const westObj = ZODIAC.find(z=>z.id===westId);
      const west = westObj ? `${westObj.name}（${westObj.range}）` : "—";

      const cz = getChineseZodiacByYear(dt.getFullYear());
      const gzObj = getGanzhiByYear(dt.getFullYear());
      const gz = gzObj.gz;
      const wx = STEM_ELEMENT[gzObj.stem] || "—";

      const a = ageApprox(dt);
      const ageYears = Number(a.years.toFixed(2));

      return {
        "姓名": f.name,
        "生日": f.dob,
        "月/日": mdText(dt),
        "年齡(歲)": ageYears,
        "西方星座": west,
        "星座ID": westId,
        "中國生肖": cz,
        "天干地支": gz,
        "五行": wx,
        "性別": sexLabel(f.sex || "unspecified"),
        "關係分類": f.tag || ""
      };
    });

    const byMonthDay = [...rows].sort((a,b)=> a["月/日"].localeCompare(b["月/日"]));
    const byAgeYoungToOld = [...rows].sort((a,b)=> {
      // younger first = later DOB first
      const ad = a["生日"];
      const bd = b["生日"];
      return bd.localeCompare(ad);
    });

    // Chinese zodiac grouping (Rat -> Pig)
    const czOrder = new Map();
    CHINESE_ZODIAC.forEach((z,i)=>czOrder.set(z, i));
    const byChineseZodiac = [...rows].sort((a,b)=>{
      const ai = czOrder.has(a["中國生肖"]) ? czOrder.get(a["中國生肖"]) : 999;
      const bi = czOrder.has(b["中國生肖"]) ? czOrder.get(b["中國生肖"]) : 999;
      if(ai !== bi) return ai - bi;
      return a["月/日"].localeCompare(b["月/日"]);
    });

    // Relationship sheets (skip empty)
    const relGroups = {};
    for(const r of rows){
      const tag = r["關係分類"] || "";
      if(!tag) continue;
      if(!relGroups[tag]) relGroups[tag] = [];
      relGroups[tag].push(r);
    }
    for(const k of Object.keys(relGroups)){
      relGroups[k].sort((a,b)=>a["月/日"].localeCompare(b["月/日"]));
    }

    // ---- build workbook ----
    const wb = XLSX.utils.book_new();

    const headers = ["姓名","生日","月/日","年齡(歲)","西方星座","中國生肖","天干地支","五行","性別","關係分類"];

    const addSheetFromJson = (sheetName, jsonRows)=>{
      const data = [headers, ...jsonRows.map(r=>headers.map(h=>r[h] ?? ""))];
      const ws = XLSX.utils.aoa_to_sheet(data);

      // basic column widths
      ws["!cols"] = [
        {wch: 12}, {wch: 12}, {wch: 7}, {wch: 10}, {wch: 18},
        {wch: 10}, {wch: 10}, {wch: 6}, {wch: 8}, {wch: 10}
      ];
      XLSX.utils.book_append_sheet(wb, ws, safeSheetName(sheetName));
    };

    // Total / master
    addSheetFromJson("總表", byMonthDay);

    // (月份) 1/1 -> 12/31
    addSheetFromJson("月份_0101-1231", byMonthDay);

    // (星座) ordered by date (1/1 -> 12/31); shows zodiac column
    addSheetFromJson("星座_0101-1231", byMonthDay);

    // (生肖) Rat -> Pig
    addSheetFromJson("生肖_鼠到豬", byChineseZodiac);

    // (年齡) young -> old
    addSheetFromJson("年齡_由細至大", byAgeYoungToOld);

    // relationship sheets
    const relNames = Object.keys(relGroups).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
    for(const rel of relNames){
      const list = relGroups[rel] || [];
      if(list.length === 0) continue;
      addSheetFromJson(`關係_${rel}_0101-1231`, list);
    }

    try{
      XLSX.writeFile(wb, `Friends_${ts}.xlsx`, {bookType:"xlsx"});
    }catch(err){
      console.error(err);
      alert("匯出失敗：瀏覽器可能阻擋下載或不支援此功能。請改用桌面瀏覽器（Chrome/Safari/Edge）重試。");
    }
  }


  function getZodiacCounts(){
    const map = new Map();
    for(const z of ZODIAC) map.set(z.id, 0);
    const list = loadFriends();
    for(const f of list){
      const dt = parseDateOnly(f.dob);
      const id = getWesternZodiacId(dt);
      if(map.has(id)) map.set(id, (map.get(id)||0)+1);
    }
    return map;
  }

  function getTagCounts(){
    const map = new Map();
    for(const t of TAGS) map.set(t, 0);
    const list = loadFriends();
    for(const f of list){
      const t = (f.tag||"").trim();
      if(t && map.has(t)) map.set(t, (map.get(t)||0)+1);
    }
    return map;
  }


  // ============================
  // Render: Zodiac filter buttons
  // ============================
  function renderZodiacFilters(){
    const box = document.getElementById("zodiacFilters");
    box.innerHTML = "";

    const zCounts = getZodiacCounts();
    const list = loadFriends();

    const allBtn = document.createElement("button");
    allBtn.className = "filterBtn" + (zodiacFilter==="__all__" ? " active" : "");
    allBtn.dataset.zid = "__all__";
    allBtn.innerHTML = `<span>全部</span><span class="countPill">${list.length}</span>`;
    allBtn.addEventListener("click", ()=>{
      zodiacFilter = "__all__";
      updateZodiacBadge();
      renderFriends();
      setActiveZodiacButtons();
    });
    box.appendChild(allBtn);

    for(const z of ZODIAC){
      const btn = document.createElement("button");
      btn.className = "filterBtn" + (zodiacFilter===z.id ? " active" : "");
      btn.dataset.zid = z.id;
      btn.innerHTML = `<span>${z.name}</span><span class="countPill">${zCounts.get(z.id)||0}</span>`;
      btn.title = z.range;
      btn.addEventListener("click", ()=>{
        zodiacFilter = z.id;
        updateZodiacBadge();
        renderFriends();
        setActiveZodiacButtons();
      });
      box.appendChild(btn);
    }
  }

  function setActiveZodiacButtons(){
  const btns = document.querySelectorAll("#zodiacFilters .filterBtn");
  btns.forEach(b=> b.classList.remove("active"));
  btns.forEach(b=>{
    const id = b.dataset.zid || "";
    if(zodiacFilter==="__all__" && id==="__all__") b.classList.add("active");
    if(zodiacFilter!=="__all__" && id===zodiacFilter) b.classList.add("active");
  });
}

  function updateZodiacBadge(){
    const b = document.getElementById("zodiacBadge");
    if(zodiacFilter==="__all__"){
      b.textContent = "顯示：全部";
      return;
    }
    const z = ZODIAC.find(x=>x.id===zodiacFilter);
    b.textContent = z ? `顯示：${z.name}` : "顯示：—";
  }

  
  // ============================
  // Render: Tag/Relation filter buttons
  // ============================
  function renderTagFilters(){
    const box = document.getElementById("tagFilters");
    if(!box) return;
    box.innerHTML = "";

    const tCounts = getTagCounts();
    const list = loadFriends();

    const allBtn = document.createElement("button");
    allBtn.className = "filterBtn" + (tagFilter==="__all__" ? " active" : "");
    allBtn.dataset.tid = "__all__";
    allBtn.innerHTML = `<span>全部</span><span class="countPill">${list.length}</span>`;
    allBtn.addEventListener("click", ()=>{
      tagFilter = "__all__";
      updateTagBadge();
      setActiveTagButtons();
      renderFriends();
    });
    box.appendChild(allBtn);

    for(const t of TAGS){
      const btn = document.createElement("button");
      btn.className = "filterBtn" + (tagFilter===t ? " active" : "");
      btn.dataset.tid = t;
      btn.innerHTML = `<span>${t}</span><span class="countPill">${tCounts.get(t)||0}</span>`;
      btn.addEventListener("click", ()=>{
        if(tagFilter===t){
          tagFilter="__all__";
        }else{
          tagFilter=t;
        }
        updateTagBadge();
        setActiveTagButtons();
        renderFriends();
      });
      box.appendChild(btn);
    }
  }

  function setActiveTagButtons(){
  const box = document.getElementById("tagFilters");
  if(!box) return;
  const btns = box.querySelectorAll("button");
  btns.forEach(b=>b.classList.remove("active"));
  btns.forEach(b=>{
    const id = b.dataset.tid || "";
    if(tagFilter==="__all__" && id==="__all__") b.classList.add("active");
    if(tagFilter!=="__all__" && id===tagFilter) b.classList.add("active");
  });
}

  function updateTagBadge(){
    const b = document.getElementById("tagBadge");
    if(!b) return;
    b.textContent = (tagFilter==="__all__") ? "顯示：全部" : `顯示：${tagFilter}`;
  }

  function setMonthControlButtons(){
    const g = document.getElementById("layoutGridBtn");
    const r = document.getElementById("layoutRowBtn");
    const sm = document.getElementById("sortMonthBtn");
    const sc = document.getElementById("sortCountBtn");
    if(g && r){
      g.classList.toggle("active", monthLayout==="grid");
      r.classList.toggle("active", monthLayout==="row");
    }
    if(sm && sc){
      sm.classList.toggle("active", monthSort==="month");
      sc.classList.toggle("active", monthSort==="count");
    }
  }


// ============================
  // Render: Month board + leaderboard
  // ============================
  function renderMonthBoard(listFiltered){
    const board = document.getElementById("monthBoard");
    board.innerHTML = "";
    board.classList.toggle("rowLayout", monthLayout==="row");

    const groups = new Map();
    for(let m=1;m<=12;m++) groups.set(m, []);

    for(const f of listFiltered){
      const dt = parseDateOnly(f.dob);
      groups.get(dt.getMonth()+1).push({ f, dt });
    }

    const order = Array.from({length:12}, (_,i)=>i+1);

    if(monthSort==="count"){
      order.sort((a,b)=> (groups.get(b).length - groups.get(a).length) || (a-b));
    }

    for(const m of order){
      const items = groups.get(m).sort((a,b)=> a.dt.getDate() - b.dt.getDate());
      const card = document.createElement("div");
      card.className = "monthCard";
      card.setAttribute("data-m", String(m));
      card.id = `month_${m}`;

      
      const containerClass = (monthLayout==="row") ? "nameOnly" : "chips";

      
      const chips = items.slice(0, 10).map(({f,dt}) => {
        if(monthLayout==="row"){
          return `
            <div class="chip chipBtn" data-id="${f.id}" data-m="${m}" title="點擊查看詳情">
              <div class="nm">${escapeHtml(f.name)}</div>
            </div>
          `;
        }
        const a = ageApprox(dt);
        return `
          <div class="chip" data-id="${f.id}" data-m="${m}" title="點擊查看詳情">
            <div class="top">
              <div class="nm">${escapeHtml(f.name)}</div>
              <div class="dt mono">${fmtDob(f.dob)}</div>
            </div>
            <div class="sub">約 <span class="mono">${a.years.toFixed(1)}</span> 歲${f.tag ? `｜${escapeHtml(f.tag)}` : ""}</div>
          </div>
        `;
      }).join("");

      const more = items.length > 10
        ? `<div class="small" style="margin:0;position:relative;">+ 還有 ${items.length - 10} 位（本月共 ${items.length} 位）</div>`
        : (items.length === 0 ? `<div class="small" style="margin:0;position:relative;">本月暫無朋友生日</div>` : "");

      card.innerHTML = `
        <div class="monthTitle">
          <div class="m">${m} 月</div>
          <div class="cnt">${items.length} 位</div>
        </div>
        <div class="${containerClass}">${chips || ""}</div>
        ${more}
      `;
      board.appendChild(card);
    }

    board.querySelectorAll(".chip[data-id]").forEach(ch => {
      ch.addEventListener("click", ()=> openDetail(ch.getAttribute("data-id")));
    });

    document.getElementById("monthBadge").textContent =
      listFiltered.length ? `共 ${listFiltered.length} 位朋友（已套用篩選）` : "尚未加入朋友／篩選後為 0";
  }

  function renderLeaderboard(listFiltered){
    const rawAll = loadFriends();
    const select = document.getElementById("rankTagFilter");

    // Populate tag filter options (based on all friends, not filtered, so you can quickly switch)
    const tags = uniqueTags(rawAll);
    const cur = select.value || "__all__";
    select.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "__all__";
    optAll.textContent = "全部分類";
    select.appendChild(optAll);
    for(const t of tags){
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t;
      select.appendChild(o);
    }
    if([...select.options].some(o=>o.value===cur)) select.value = cur;

    // Sync dropdown with current relation filter
    try{ select.value = (tagFilter==="__all__") ? "__all__" : tagFilter; }catch(e){}

    // Apply relation filter on TOP of zodiac filter
    let working = [...listFiltered];
    if(tagFilter && tagFilter !== "__all__"){
      working = working.filter(f => (f.tag || "") === tagFilter);
    }

    // Sort oldest -> youngest (earlier DOB is older)
    working.sort((a,b)=> a.dob.localeCompare(b.dob));

    const box = document.getElementById("leaderboard");
    box.innerHTML = "";

    document.getElementById("rankBadge").textContent =
      working.length ? `${working.length} 位` : "0 位";

    if(working.length === 0){
      const empty = document.createElement("div");
      empty.className = "pill";
      empty.innerHTML = `<div class="k">目前沒有符合條件的朋友</div><div class="v" style="font-size:13px;font-weight:900;line-height:1.6;">調整「星座」或「分類」篩選後再看排行。</div>`;
      box.appendChild(empty);
      return;
    }

    for(let i=0;i<working.length;i++){
      const f = working[i];
      const dt = parseDateOnly(f.dob);
      const a = ageApprox(dt);
      const z = getWesternZodiacLabel(dt);

      const row = document.createElement("div");
      row.className = "lbRow";
      row.addEventListener("click", ()=> openDetail(f.id));
      row.innerHTML = `
        <div class="rank">${i+1}</div>
        <div class="lbMain">
          <div class="nm">${escapeHtml(f.name)}</div>
          <div class="meta">
            生日：<span class="mono">${f.dob}</span>（${fmtDob(f.dob)}）
            ${f.tag ? `｜${escapeHtml(f.tag)}` : ""}
            <br/>星座：${escapeHtml(z)}
          </div>
        </div>
        <div class="lbRight">
          <div class="age mono">${a.years.toFixed(2)} 歲</div>
          <div class="days mono">${a.days.toLocaleString("zh-Hant-TW")} 天</div>
        </div>
      `;
      box.appendChild(row);
    }
  }

  
  function updateGroupPosition(){
    const badge = document.getElementById("gpBadge");
    const rankEl = document.getElementById("gpRank");
    const aheadEl = document.getElementById("gpAhead");
    const closeEl = document.getElementById("gpClosest");
    if(!badge || !rankEl || !aheadEl || !closeEl) return;

    const ctx = window.__SELF_CTX;
    if(!ctx || !isFinite(ctx.rawPct)){
      badge.textContent = "等待計算";
      rankEl.textContent = "—";
      aheadEl.textContent = "—";
      closeEl.textContent = "—";
      return;
    }

    const friends = loadFriends();
    const baseLife = Number(ctx.lifeExpYears);
    const base = [];
    // self
    base.push({ id:"__me__", name:"你", pct: Number(ctx.rawPct) });

    // friends under same denominator
    for(const f of friends){
      const dt = parseDateOnly(f.dob);
      if(!dt) continue;
      const diff = (new Date()) - dt;
      const total = baseLife * 365.2425 * 24 * 3600 * 1000;
      const pct = (diff / total) * 100;
      base.push({ id:f.id, name:f.name, pct });
    }

    // sort by pct desc (more "ahead" first)
    const sorted = [...base].sort((a,b)=> b.pct - a.pct);
    const n = sorted.length;
    const meIndex = sorted.findIndex(x=>x.id==="__me__");
    const rank = (meIndex>=0) ? (meIndex+1) : n;

    // ahead percentage relative to friends only
    const friendsOnly = base.filter(x=>x.id!=="__me__");
    const denom = friendsOnly.length;
    if(denom===0){
      badge.textContent = "只有你自己";
      rankEl.textContent = `第 1 / 1 位`;
      aheadEl.textContent = "—";
      closeEl.textContent = "—";
      return;
    }

    const mePct = base.find(x=>x.id==="__me__").pct;
    const behindCount = friendsOnly.filter(x=>x.pct < mePct).length;
    const aheadPct = (behindCount / denom) * 100;

    // closest
    let closest = null;
    for(const f of friendsOnly){
      const d = Math.abs(f.pct - mePct);
      if(closest===null || d < closest.diff){
        closest = { name: f.name, diff: d };
      }
    }

    badge.textContent = "已更新";
    rankEl.textContent = `第 ${rank} / ${n} 位`;
    aheadEl.textContent = `${aheadPct.toFixed(0)}%（${behindCount} / ${denom}）`;
    closeEl.textContent = closest ? `${closest.name}（差 ${closest.diff.toFixed(2)}%）` : "—";
  }


function renderFriends(){
    const all = loadFriends();
    document.getElementById("friendsBadge").textContent = `${all.length} 位朋友`;

    const filtered = applyTagFilter(applyZodiacFilter(all));

    // refresh filter UIs (counts may change)
    renderZodiacFilters();
    updateZodiacBadge();
    renderTagFilters();
    updateTagBadge();

    renderMonthBoard(filtered);
    renderLeaderboard(filtered);
  }

  function addFriend(){
    const name = document.getElementById("friendName").value.trim();
    const dob = document.getElementById("friendDob").value;
    const sex = document.getElementById("friendSex").value;
    const tag = document.getElementById("friendTag").value;

    if(!name){ alert("請輸入朋友名字"); return; }
    if(!dob){ alert("請輸入朋友出生年月日"); return; }

    const list = loadFriends();
    list.push({ id: uuid(), name, dob, sex, tag });
    saveFriends(list);

    document.getElementById("friendName").value = "";
    document.getElementById("friendDob").value = "";
    document.getElementById("friendTag").value = "";
    document.getElementById("friendSex").value = "unspecified";

    renderFriends();
    updateGroupPosition();
  }

  function clearFriends(){
    const ok = confirm("確定要清空所有朋友名單？此動作不可復原。");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    renderFriends();
    updateGroupPosition();
  }

  // ============================
  // Wire up
  // ============================
  // ============================
// UI: Language + Basis country (main page)
// ============================
let lang = localStorage.getItem("life_lang") || "zh-Hant";
const langSel = document.getElementById("langSelect");
if(langSel){
  langSel.value = (lang==="en") ? "en" : "zh-Hant";
  langSel.addEventListener("change", ()=>{
    lang = langSel.value;
    localStorage.setItem("life_lang", lang);
    // Minimal UI switch (extendable)
    document.getElementById("status").textContent = (lang==="en") ? "Ready" : "等待輸入";
    // You can extend more strings later.
  });
}

const basisSel = document.getElementById("basisCountry");
if(basisSel){
  const saved = localStorage.getItem("life_basis_country") || "auto";
  basisSel.value = saved;
  basisSel.addEventListener("change", ()=>{
    localStorage.setItem("life_basis_country", basisSel.value);
  });
}

  document.getElementById("calcBtn").addEventListener("click", runWithLocation);
  document.getElementById("calcManualBtn").addEventListener("click", runManual);

  document.getElementById("goFriendsBtn").addEventListener("click", ()=> showPage("friends"));
  document.getElementById("backBtn").addEventListener("click", ()=> showPage("main"));

  document.getElementById("addFriendBtn").addEventListener("click", addFriend);
  document.getElementById("clearBtn").addEventListener("click", clearFriends);
  document.getElementById("exportExcelBtn").addEventListener("click", exportExcelWorkbook);

  document.getElementById("closeOverlayBtn").addEventListener("click", closeDetail);
  document.getElementById("overlay").addEventListener("click", (e)=>{
    if(e.target && e.target.id === "overlay") closeDetail();
  });
  document.getElementById("deleteFriendBtn").addEventListener("click", deleteCurrent);
  document.getElementById("jumpMonthBtn").addEventListener("click", jumpCurrentMonth);

  document.getElementById("rankTagFilter").addEventListener("change", (e)=>{
    const v = e.target.value;
    tagFilter = (v && v !== "__all__") ? v : "__all__";
    updateTagBadge();
    setActiveTagButtons();
    renderFriends();
  });

  // Month layout / sort controls
  document.getElementById("layoutGridBtn").addEventListener("click", ()=>{
    monthLayout = "grid";
    setMonthControlButtons();
    renderFriends();
  });
  document.getElementById("layoutRowBtn").addEventListener("click", ()=>{
    monthLayout = "row";
    setMonthControlButtons();
    renderFriends();
  });
  document.getElementById("sortMonthBtn").addEventListener("click", ()=>{
    monthSort = "month";
    setMonthControlButtons();
    renderFriends();
  });
  document.getElementById("sortCountBtn").addEventListener("click", ()=>{
    monthSort = "count";
    setMonthControlButtons();
    renderFriends();
  });


  window.addEventListener("hashchange", ()=>{
    if(location.hash === "#friends") showPage("friends");
    else showPage("main");
  });
  if(location.hash === "#friends") showPage("friends");

  // initial render
  renderZodiacFilters();
  updateZodiacBadge();
  renderTagFilters();
  updateTagBadge();
  setMonthControlButtons();
  renderFriends();

  // --- Added: i18n (minimal) ---
  const I18N = {
    "zh-Hant": {
      langLabel: "介面語言",
      basisCountryLabel: "壽命基準國家",
    },
    "en": {
      langLabel: "Language",
      basisCountryLabel: "Life expectancy basis",
    }
  };

  function applyI18n(lang){
    document.documentElement.lang = lang === "en" ? "en" : "zh-Hant";
    for(const el of document.querySelectorAll("[data-i18n]")){
      const key = el.getAttribute("data-i18n");
      const txt = (I18N[lang] && I18N[lang][key]) ? I18N[lang][key] : (I18N["zh-Hant"][key] || "");
      if(txt) el.textContent = txt;
    }
  }

  // --- Added: fallback life expectancy (years) for common countries (approx, used only if API fails) ---
  const LIFE_FALLBACK = {
    "TW": { total: 80.9, male: 77.6, female: 84.3 },
    "HK": { total: 85.6, male: 83.0, female: 88.3 },
    "JP": { total: 84.8, male: 81.6, female: 87.9 },
    "CN": { total: 78.0, male: 75.6, female: 80.6 },
    "US": { total: 77.5, male: 74.8, female: 80.2 },
    "GB": { total: 81.0, male: 79.3, female: 82.7 },
    "SG": { total: 83.7, male: 81.6, female: 85.8 },
    "KR": { total: 83.6, male: 80.6, female: 86.6 },
    "AU": { total: 83.2, male: 81.3, female: 85.1 },
    "CA": { total: 82.2, male: 80.4, female: 84.0 },
    "SE": { total: 83.2, male: 81.5, female: 84.9 },
    "DE": { total: 81.2, male: 78.8, female: 83.6 },
    "FR": { total: 82.6, male: 79.5, female: 85.6 }
  };

  function normalizeCC(code){
    if(!code) return null;
    if(code==="—") return null;
    return String(code).toUpperCase();
  }

  async function fetchLifeExpectancySafe(countryCode, sex){
    const cc = normalizeCC(countryCode);
    if(!cc) throw new Error("No country code");
    try{
      // try World Bank first
      const { value, year, indicator } = await fetchLifeExpectancy(cc.toLowerCase(), sex);
      return { value, year, indicator, source: "worldbank" };
    }catch(e){
      const fb = LIFE_FALLBACK[cc];
      if(fb){
        const v = (sex==="male") ? fb.male : (sex==="female" ? fb.female : fb.total);
        return { value: v, year: "fallback", indicator: "fallback", source: "fallback" };
      }
      throw e;
    }
  }

  // --- Added: next birthday helpers ---
  function daysUntilBirthday(dobDate){
    // dobDate: Date (date-only)
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let next = new Date(today.getFullYear(), dobDate.getMonth(), dobDate.getDate());
    if(next < today) next = new Date(today.getFullYear()+1, dobDate.getMonth(), dobDate.getDate());
    const diff = next - today;
    return Math.ceil(diff / 86400000);
  }

  function formatNextBirthdayLine(f){
    const dt = parseDateOnly(f.dob);
    const d = daysUntilBirthday(dt);
    const when = (d===0) ? "今天" : `${d} 天後`;
    return `${f.name}（${when}）`;
  }

  function computeNextBirthday(list){
    if(!list || list.length===0) return null;
    const scored = list.map(f=>{
      const dt = parseDateOnly(f.dob);
      return { f, d: daysUntilBirthday(dt) };
    }).sort((a,b)=> a.d - b.d);
    return scored[0];
  }

  function updateNextBirthdayUI(){
    // MAIN: based on stored friends
    const friends = loadFriends ? loadFriends() : [];
    const next = computeNextBirthday(friends);
    const mainBox = document.getElementById("nextBdayMain");
    const mainText = document.getElementById("nextBdayMainText");
    const friendsText = document.getElementById("nextBdayFriendsText");
    if(next){
      if(mainBox) mainBox.style.display = "block";
      if(mainText) mainText.textContent = formatNextBirthdayLine(next.f);
      if(friendsText) friendsText.textContent = formatNextBirthdayLine(next.f);
    }else{
      if(mainBox) mainBox.style.display = "none";
      if(friendsText) friendsText.textContent = "—";
    }
  }

  // --- Added: life basis selection wiring ---
  function getBasisCountryFromUI(){
    const sel = document.getElementById("basisCountry");
    return sel ? sel.value : "auto";
  }

  function persistBasis(){
    const lang = document.getElementById("langSel")?.value || "zh-Hant";
    const basis = getBasisCountryFromUI();
    localStorage.setItem("life_lang", lang);
    localStorage.setItem("life_basis_country", basis);
  }

  function loadBasis(){
    const lang = localStorage.getItem("life_lang") || "zh-Hant";
    const basis = localStorage.getItem("life_basis_country") || "auto";
    const langSel = document.getElementById("langSel");
    const basisSel = document.getElementById("basisCountry");
    if(langSel) langSel.value = lang;
    if(basisSel) basisSel.value = basis;
    applyI18n(lang);
  }

  // Patch: runWithLocation now respects basisCountry (auto vs manual country)
  const _runWithLocation = runWithLocation;
  runWithLocation = async function(){
    const birth = parseBirthDateTime();
    if(!birth){ alert("請先輸入出生年月日"); return; }
    if(timer){ clearInterval(timer); timer = null; }

    persistBasis();

    const sex = document.getElementById("sex").value;
    const basis = getBasisCountryFromUI();

    try{
      let cc = null;

      if(basis === "auto"){
        setStatus("取得地點中…", "warn");
        document.getElementById("locBadge").textContent = "請允許定位";
        document.getElementById("locBadge").className = "badge warn";
        cc = (await getLocationCountryCode()).toUpperCase();
      }else{
        cc = basis.toUpperCase();
        document.getElementById("locBadge").textContent = `手動：${cc}`;
        document.getElementById("locBadge").className = "badge";
        setStatus("讀取平均壽命中…", "warn");
      }

      const { value, year, indicator } = await fetchLifeExpectancySafe(cc, sex);

      // persist for friends progress leaderboard
      localStorage.setItem("life_last_country", cc);
      localStorage.setItem("life_last_sex", sex);
      localStorage.setItem("life_last_value", String(value));
      localStorage.setItem("life_last_year", String(year));
      localStorage.setItem("life_last_indicator", String(indicator));

      const mode = document.getElementById("mode").value;
      computeAndRender(birth, value, cc, sex, indicator, year);

      if(mode === "live"){
        timer = setInterval(()=> computeAndRender(birth, value, cc, sex, indicator, year), 1000);
      }
    }catch(err){
      console.error(err);
      setStatus("取得失敗", "danger");
      document.getElementById("locBadge").textContent = "未取得";
      document.getElementById("locBadge").className = "badge danger";
      alert("取得地點/平均壽命失敗。建議：\\n1) 允許定位（auto）\\n2) 或改選『手動國家』\\n3) 或使用『手動輸入壽命』模式。");
    }
  }

  // Patch: runManual should persist last value for friends progress
  const _runManual = runManual;
  runManual = function(){
    const birth = parseBirthDateTime();
    if(!birth){ alert("請先輸入出生年月日"); return; }
    const v = prompt("請輸入你想用的『假設壽命（年）』，例如 80 或 84.6：", "80");
    if(!v) return;
    const life = Number(v);
    if(!isFinite(life) || life <= 0 || life > 130){ alert("壽命數值不合理，請輸入 1～130。"); return; }

    persistBasis();

    if(timer){ clearInterval(timer); timer = null; }
    const sex = document.getElementById("sex").value;
    const mode = document.getElementById("mode").value;
    setStatus("已更新（手動）", "");

    localStorage.setItem("life_last_country", "manual");
    localStorage.setItem("life_last_sex", sex);
    localStorage.setItem("life_last_value", String(life));
    localStorage.setItem("life_last_year", "manual");
    localStorage.setItem("life_last_indicator", "manual");

    computeAndRender(birth, life, "—", sex, "manual", "—");
    if(mode === "live"){
      timer = setInterval(()=> computeAndRender(birth, life, "—", sex, "manual", "—"), 1000);
    }
  }

  // --- Added: month chips show days to birthday (3x4 layout) ---
  const _renderMonthBoard = renderMonthBoard;
  renderMonthBoard = function(listFiltered){
    // reuse original but with small template patch via global flag
    _renderMonthBoard(listFiltered);
    // After DOM created, enhance chips with days-to-bday text where applicable
    if(monthLayout !== "row"){
      for(const chip of document.querySelectorAll(".chip[data-id]")){
        const id = chip.getAttribute("data-id");
        const list = loadFriends();
        const f = list.find(x=>x.id===id);
        if(!f) continue;
        const dt = parseDateOnly(f.dob);
        const d = daysUntilBirthday(dt);
        const sub = chip.querySelector(".sub");
        if(sub){
          const extra = document.createElement("div");
          extra.className = "sub";
          extra.style.marginTop = "4px";
          extra.innerHTML = `距離生日：還有 <span class="mono">${d}</span> 天`;
          sub.insertAdjacentElement("afterend", extra);
        }
      }
    }
  }

  // --- Added: progress leaderboard mode ---
  let rankMode = "age";

  
  function getRankLifeBasisSync(){
    const sel = document.getElementById("rankBasisCountry");
    const v = sel ? sel.value : "__main__";
    if(v === "__main__"){
      const lastValue = Number(localStorage.getItem("life_last_value") || "0");
      if(isFinite(lastValue) && lastValue>0){
        return { country: localStorage.getItem("life_last_country") || "manual", life: lastValue };
      }
      return { country: "manual", life: 80 };
    }

    if(v === "auto"){
      // Friends page prioritizes stability (no geo prompt here). Use main page's last value if available.
      const lastValue = Number(localStorage.getItem("life_last_value") || "0");
      if(isFinite(lastValue) && lastValue>0){
        return { country: localStorage.getItem("life_last_country") || "auto", life: lastValue };
      }
      return { country: "manual", life: 80 };
    }

    const cc = String(v).toUpperCase();
    const fb = LIFE_FALLBACK[cc];
    const life = fb ? fb.total : 80;
    return { country: cc, life };
  }


  const _renderLeaderboard = renderLeaderboard;
  renderLeaderboard = function(listFiltered){
    // call original to build base, then if rankMode==progress re-render body
    if(rankMode === "age"){
      document.getElementById("rankTitle").textContent = "年齡排行榜";
      return _renderLeaderboard(listFiltered);
    }

    document.getElementById("rankTitle").textContent = "人生進度% 排行榜";

    const rawAll = loadFriends();
    const select = document.getElementById("rankTagFilter");
    const tags = uniqueTags(rawAll);
    const cur = select.value || "__all__";
    select.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "__all__";
    optAll.textContent = "全部分類";
    select.appendChild(optAll);
    for(const t of tags){
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t;
      if(t===cur) o.selected = true;
      select.appendChild(o);
    }

    // apply tag filter
    let working = listFiltered.slice();
    const tagPick = select.value;
    if(tagPick && tagPick !== "__all__"){
      working = working.filter(x => (x.tag||"") === tagPick);
    }

    const box = document.getElementById("leaderboard");
    box.innerHTML = "";

    document.getElementById("rankBadge").textContent = working.length ? `${working.length} 位` : "0 位";

    if(working.length===0){
      const empty = document.createElement("div");
      empty.className="pill";
      empty.innerHTML = `<div class="k">目前沒有符合條件的朋友</div><div class="v" style="font-size:14px;font-weight:900;line-height:1.6;">調整篩選後再看排行。</div>`;
      box.appendChild(empty);
      return;
    }

    const basis = getRankLifeBasisSync();
    // compute progress
    const scored = working.map(f=>{
      const dt = parseDateOnly(f.dob);
      const ageYears = (Date.now() - dt.getTime()) / (365.2425*86400000);
      const pct = Math.max(0, Math.min(999, (ageYears / basis.life) * 100));
      return { f, dt, ageYears, pct };
    }).sort((a,b)=> b.pct - a.pct);

    for(let i=0;i<scored.length;i++){
      const { f, dt, pct } = scored[i];
      const z = getWesternZodiacLabel(dt);
      const row = document.createElement("div");
      row.className="lbRow";
      row.style.setProperty("--pct", String(pct));
      if(pct>=100) row.classList.add("over");
      row.addEventListener("click", ()=> openDetail(f.id));
      row.innerHTML = `
        <div class="rank">${i+1}</div>
        <div class="lbMain">
          <div class="nm">${escapeHtml(f.name)}</div>
          <div class="meta">
            生日：<span class="mono">${f.dob}</span>（${fmtDob(f.dob)}）
            ${f.tag ? `｜${escapeHtml(f.tag)}` : ""}
            <br/>星座：${escapeHtml(z)}
          </div>
        </div>
        <div class="lbRight">
          <div class="big mono">${pct.toFixed(2)}%</div>
          <div class="sm">基準：${escapeHtml(String(basis.country).toUpperCase())}｜${basis.life.toFixed(1)} yr</div>
        </div>
      `;
      box.appendChild(row);
    }
  }

  function setRankMode(mode){
    rankMode = mode;
    document.getElementById("rankModeAge").classList.toggle("active", mode==="age");
    document.getElementById("rankModeProgress").classList.toggle("active", mode==="progress");
    // trigger re-render with current filters
    renderFriends();
  }

  // --- Added: event wiring for new controls ---
  document.getElementById("langSel")?.addEventListener("change", ()=>{
    const lang = document.getElementById("langSel").value;
    localStorage.setItem("life_lang", lang);
    applyI18n(lang);
  });
  document.getElementById("basisCountry")?.addEventListener("change", persistBasis);

  document.getElementById("rankModeAge")?.addEventListener("click", ()=> setRankMode("age"));
  document.getElementById("rankModeProgress")?.addEventListener("click", ()=> setRankMode("progress"));
  document.getElementById("rankBasisCountry")?.addEventListener("change", ()=> renderFriends());
  document.getElementById("rankTagFilter")?.addEventListener("change", ()=> renderFriends());

  // init
  loadBasis();
  updateNextBirthdayUI();


</script>
</body>
</html>
